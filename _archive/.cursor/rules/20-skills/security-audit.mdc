---
description: "ë³´ì•ˆ ê°ì‚¬ ìŠ¤í‚¬ - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸"
globs: ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"]
alwaysApply: false
---

# Security Audit Skill

ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ ê°ì‚¬ ê°€ì´ë“œì…ë‹ˆë‹¤.

---

## ğŸ”’ OWASP Top 10 ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1. Injection (ì¸ì ì…˜)

```typescript
// âŒ SQL Injection ì·¨ì•½
const query = `SELECT * FROM users WHERE id = ${userId}`;

// âœ… Parameterized Query
const query = 'SELECT * FROM users WHERE id = ?';
db.query(query, [userId]);

// âŒ Command Injection ì·¨ì•½
exec(`ls ${userInput}`);

// âœ… ì•ˆì „í•œ ë°©ë²•
execFile('ls', [sanitizedPath]);
```

### 2. Broken Authentication (ì¸ì¦ ì·¨ì•½ì )

```typescript
// âŒ ì·¨ì•½í•œ ì„¸ì…˜ ê´€ë¦¬
document.cookie = `session=${token}`;  // HttpOnly ì—†ìŒ

// âœ… ì•ˆì „í•œ ì¿ í‚¤ ì„¤ì •
res.cookie('session', token, {
  httpOnly: true,    // JavaScript ì ‘ê·¼ ì°¨ë‹¨
  secure: true,      // HTTPSë§Œ í—ˆìš©
  sameSite: 'strict', // CSRF ë°©ì§€
  maxAge: 3600000    // ë§Œë£Œ ì‹œê°„
});

// âœ… ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
import bcrypt from 'bcrypt';
const hash = await bcrypt.hash(password, 12);
const isValid = await bcrypt.compare(password, hash);
```

### 3. Sensitive Data Exposure (ë¯¼ê° ë°ì´í„° ë…¸ì¶œ)

```typescript
// âŒ ë¯¼ê° ë°ì´í„° ë¡œê¹…
console.log('User password:', password);
console.log('Credit card:', cardNumber);

// âœ… ë¯¼ê° ë°ì´í„° ë§ˆìŠ¤í‚¹
console.log('User logged in:', email);
console.log('Card:', maskCard(cardNumber)); // **** **** **** 1234

// âŒ í´ë¼ì´ì–¸íŠ¸ì— ë¯¼ê° ë°ì´í„° ì „ì†¡
return { user: { ...user, password: user.password } };

// âœ… í•„ìš”í•œ ë°ì´í„°ë§Œ ì „ì†¡
return { user: { id: user.id, email: user.email } };
```

### 4. XSS (Cross-Site Scripting)

```typescript
// âŒ XSS ì·¨ì•½
element.innerHTML = userInput;
<div dangerouslySetInnerHTML={{ __html: userInput }} />

// âœ… ì•ˆì „í•œ ë Œë”ë§
element.textContent = userInput;
<div>{userInput}</div>  // ReactëŠ” ìë™ ì´ìŠ¤ì¼€ì´í”„

// âœ… í•„ìš”ì‹œ sanitize
import DOMPurify from 'dompurify';
const clean = DOMPurify.sanitize(userInput);
```

### 5. CSRF (Cross-Site Request Forgery)

```typescript
// âœ… CSRF í† í° ì‚¬ìš©
// ì„œë²„: í† í° ìƒì„±
const csrfToken = crypto.randomUUID();
req.session.csrfToken = csrfToken;

// í´ë¼ì´ì–¸íŠ¸: í† í° í¬í•¨
fetch('/api/transfer', {
  method: 'POST',
  headers: {
    'X-CSRF-Token': csrfToken
  },
  body: JSON.stringify(data)
});

// ì„œë²„: í† í° ê²€ì¦
if (req.headers['x-csrf-token'] !== req.session.csrfToken) {
  return res.status(403).json({ error: 'Invalid CSRF token' });
}
```

---

## ğŸ“‹ ì…ë ¥ ê²€ì¦

### 1. ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦ (í•„ìˆ˜)

```typescript
import { z } from 'zod';

// ìŠ¤í‚¤ë§ˆ ì •ì˜
const userSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8).max(100),
  age: z.number().int().min(0).max(150),
});

// ê²€ì¦
function createUser(input: unknown) {
  const validated = userSchema.parse(input);  // ì‹¤íŒ¨ì‹œ ì—ëŸ¬
  // ë˜ëŠ”
  const result = userSchema.safeParse(input);
  if (!result.success) {
    return { error: result.error.issues };
  }
  return createUserInDB(result.data);
}
```

### 2. í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹

```typescript
// âŒ ë¸”ë™ë¦¬ìŠ¤íŠ¸ (ìš°íšŒ ê°€ëŠ¥)
if (input.includes('<script>')) reject();

// âœ… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (í—ˆìš©ëœ ê²ƒë§Œ)
const allowedRoles = ['user', 'admin', 'moderator'];
if (!allowedRoles.includes(role)) {
  throw new Error('Invalid role');
}

// âœ… ì •ê·œì‹ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
if (!usernameRegex.test(username)) {
  throw new Error('Invalid username format');
}
```

---

## ğŸ“‹ ì¸ì¦ & ê¶Œí•œ

### 1. JWT ë³´ì•ˆ

```typescript
// âŒ ì·¨ì•½í•œ JWT
const token = jwt.sign(payload, 'simple-secret');

// âœ… ì•ˆì „í•œ JWT
const token = jwt.sign(payload, process.env.JWT_SECRET, {
  algorithm: 'RS256',    // ë¹„ëŒ€ì¹­ ì•Œê³ ë¦¬ì¦˜
  expiresIn: '15m',      // ì§§ì€ ë§Œë£Œ
  issuer: 'my-app',
  audience: 'my-app-users'
});

// âœ… í† í° ê²€ì¦
try {
  const decoded = jwt.verify(token, publicKey, {
    algorithms: ['RS256'],
    issuer: 'my-app'
  });
} catch (error) {
  // ë§Œë£Œ, ìœ„ì¡° ë“±
}
```

### 2. ê¶Œí•œ ê²€ì‚¬

```typescript
// âŒ ê¶Œí•œ ê²€ì‚¬ ëˆ„ë½
app.delete('/api/posts/:id', async (req, res) => {
  await deletePost(req.params.id);  // ëˆ„êµ¬ë‚˜ ì‚­ì œ ê°€ëŠ¥!
});

// âœ… ê¶Œí•œ ê²€ì‚¬ í¬í•¨
app.delete('/api/posts/:id', authenticate, async (req, res) => {
  const post = await getPost(req.params.id);
  
  // ì†Œìœ ì ë˜ëŠ” ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥
  if (post.authorId !== req.user.id && req.user.role !== 'admin') {
    return res.status(403).json({ error: 'Forbidden' });
  }
  
  await deletePost(req.params.id);
});
```

---

## ğŸ“‹ API ë³´ì•ˆ

### 1. Rate Limiting

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15ë¶„
  max: 100,                   // ìš”ì²­ ì œí•œ
  message: 'Too many requests',
  standardHeaders: true,
  legacyHeaders: false,
});

app.use('/api/', limiter);

// ë¡œê·¸ì¸ì€ ë” ì—„ê²©í•˜ê²Œ
const loginLimiter = rateLimit({
  windowMs: 60 * 60 * 1000,  // 1ì‹œê°„
  max: 5,                     // 5íšŒ ì‹œë„
  message: 'Too many login attempts'
});

app.post('/api/login', loginLimiter, loginHandler);
```

### 2. CORS ì„¤ì •

```typescript
import cors from 'cors';

// âŒ ë„ˆë¬´ ê°œë°©ì 
app.use(cors());  // ëª¨ë“  origin í—ˆìš©

// âœ… ì œí•œì  CORS
app.use(cors({
  origin: ['https://myapp.com', 'https://admin.myapp.com'],
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400  // preflight ìºì‹œ
}));
```

### 3. ë³´ì•ˆ í—¤ë”

```typescript
import helmet from 'helmet';

app.use(helmet());  // ê¸°ë³¸ ë³´ì•ˆ í—¤ë”

// ë˜ëŠ” ê°œë³„ ì„¤ì •
app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    imgSrc: ["'self'", "data:", "https:"],
  }
}));
```

---

## ğŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ

### 1. ìµœì†Œ ê¶Œí•œ ì›ì¹™

```sql
-- âŒ ëª¨ë“  ê¶Œí•œ
GRANT ALL PRIVILEGES ON database.* TO 'app_user'@'localhost';

-- âœ… í•„ìš”í•œ ê¶Œí•œë§Œ
GRANT SELECT, INSERT, UPDATE ON database.users TO 'app_user'@'localhost';
GRANT SELECT ON database.products TO 'app_user'@'localhost';
-- DELETEëŠ” ë³„ë„ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ
```

### 2. ì—°ê²° ë³´ì•ˆ

```typescript
// âœ… SSL ì—°ê²°
const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  ssl: {
    rejectUnauthorized: true,
    ca: fs.readFileSync('/path/to/ca-cert.pem')
  }
});
```

---

## ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ & ì‹œí¬ë¦¿

### 1. ì‹œí¬ë¦¿ ê´€ë¦¬

```typescript
// âŒ í•˜ë“œì½”ë”©
const API_KEY = 'sk-1234567890abcdef';
const DB_PASSWORD = 'password123';

// âœ… í™˜ê²½ ë³€ìˆ˜
const API_KEY = process.env.API_KEY;
const DB_PASSWORD = process.env.DB_PASSWORD;

// âœ… ì‹œí¬ë¦¿ ì¡´ì¬ ê²€ì¦
const requiredEnvVars = ['API_KEY', 'DB_PASSWORD', 'JWT_SECRET'];
for (const envVar of requiredEnvVars) {
  if (!process.env[envVar]) {
    throw new Error(`Missing required environment variable: ${envVar}`);
  }
}
```

### 2. .gitignore í•„ìˆ˜

```gitignore
# í™˜ê²½ ë³€ìˆ˜
.env
.env.local
.env.*.local

# ì‹œí¬ë¦¿
*.pem
*.key
secrets/
```

---

## ğŸ“‹ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

```
ì¸ì¦/ê¶Œí•œ:
[ ] ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt/argon2)?
[ ] ì•ˆì „í•œ ì„¸ì…˜ ê´€ë¦¬?
[ ] JWT ì ì ˆí•œ ë§Œë£Œ ì‹œê°„?
[ ] ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ê¶Œí•œ ê²€ì‚¬?

ì…ë ¥ ê²€ì¦:
[ ] ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦?
[ ] SQL Injection ë°©ì§€?
[ ] XSS ë°©ì§€?

API:
[ ] Rate limiting?
[ ] CORS ì œí•œ?
[ ] ë³´ì•ˆ í—¤ë” (helmet)?
[ ] HTTPS ê°•ì œ?

ë°ì´í„°:
[ ] ë¯¼ê° ë°ì´í„° ì•”í˜¸í™”?
[ ] ë¡œê·¸ì— ë¯¼ê° ì •ë³´ ì—†ìŒ?
[ ] í™˜ê²½ ë³€ìˆ˜ë¡œ ì‹œí¬ë¦¿ ê´€ë¦¬?
[ ] .gitignore ì„¤ì •?

ì¸í”„ë¼:
[ ] ìµœì†Œ ê¶Œí•œ ì›ì¹™?
[ ] DB SSL ì—°ê²°?
[ ] ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”?
```

---

## ğŸ› ï¸ ë³´ì•ˆ ë„êµ¬

```bash
# npm ì·¨ì•½ì  ê²€ì‚¬
npm audit
npm audit fix

# Snyk (ë” ì •ë°€í•œ ê²€ì‚¬)
npx snyk test

# ì •ì  ë¶„ì„
npx eslint --ext .ts,.tsx . --rule 'security/*'
```
